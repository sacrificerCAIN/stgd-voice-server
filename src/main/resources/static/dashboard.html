<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%220.9em%22  font-size=%2290%22>ğŸ”</text></svg>">
    <title>dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            position: relative;
            min-height: 100vh;
        }

        .header-container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto 20px;
        }

        .logout-btn {
            position: absolute;
            top: 30px;
            right: 0;
            padding: 8px 15px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
        }

        .logout-btn:hover {
            background-color: #d32f2f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.danger {
            background-color: #f44336;
        }

        button.danger:hover {
            background-color: #d32f2f;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
            display: block;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 500px;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .modal-footer {
            padding: 10px 0;
            border-top: 1px solid #ddd;
            margin-top: 15px;
            text-align: right;
        }
    </style>
</head>
<body>
<!-- æ·»åŠ ç™»å‡ºæŒ‰é’®å®¹å™¨ -->
<div class="header-container">
    <button class="logout-btn" onclick="confirmLogout()">ç™»å‡º</button>
</div>

<div class="container">
    <h1>æˆ¿é—´ç®¡ç†</h1>

    <div id="message"></div>

    <button type="button" onclick="openModal()">æ·»åŠ æˆ¿é—´</button>
    <button type="button" class="secondary" onclick="loadRooms()">åˆ·æ–°åˆ—è¡¨</button>

    <h2>æˆ¿é—´åˆ—è¡¨</h2>
    <table id="roomTable">
        <thead>
        <tr>
            <th>åç§°</th>
            <th>åœ¨çº¿äººæ•°</th>
            <th>æ“ä½œ</th>
        </tr>
        </thead>
        <tbody>
        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </tbody>
    </table>
</div>

<!-- å¼¹çª— -->
<div id="roomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">æ·»åŠ æˆ¿é—´</h2>
        </div>
        <form id="roomForm">
            <input type="hidden" id="roomId">
            <div class="form-group">
                <label for="roomName">æˆ¿é—´åç§°</label>
                <input type="text" id="roomName" required>
                <label for="password">æˆ¿é—´å¯†ç </label>
                <input type="password" id="password"  onclick="cleanPassword()" required>
            </div>
        </form>
        <div class="modal-footer">
            <button type="button" onclick="submitRoom()">ä¿å­˜</button>
            <button type="button" class="secondary" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    // æ·»åŠ ç™»å‡ºç¡®è®¤å‡½æ•°
    function confirmLogout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            logout();
        }
    }

    // ç™»å‡ºå‡½æ•°
    function logout() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ ç™»å‡ºé€»è¾‘ï¼Œå¦‚æ¸…é™¤sessionç­‰
        // ç„¶åè·³è½¬åˆ°index.html
        fetch('http://localhost:8080/login/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        window.location.href = 'index.html';
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–Roomåˆ—è¡¨
    window.onload = function() {
        init();
    };

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, isSuccess) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = message;
        messageEl.className = isSuccess ? 'success' : 'error';
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }

    // æ‰“å¼€å¼¹çª—
    function openModal(room = null) {
        const modal = document.getElementById('roomModal');
        const modalTitle = document.getElementById('modalTitle');

        if (room) {
            modalTitle.textContent = 'ç¼–è¾‘æˆ¿é—´';
            document.getElementById('roomId').value = room.id;
            document.getElementById('roomName').value = room.name;
            if (room.password != null && room.password != ''){
                document.getElementById('password').setAttribute("placeholder", "ç‚¹å‡»ä¿å­˜æ¸…é™¤è¯¥æˆ¿é—´å¯†ç ï¼Œç‚¹å‡»å–æ¶ˆç»´æŒåŸå¯†ç ");
            }

            document.getElementById('password').value = room.password;
        } else {
            modalTitle.textContent = 'æ·»åŠ æˆ¿é—´';
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').value = '';
        }

        modal.style.display = 'block';
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
        document.getElementById('roomModal').style.display = 'none';
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('roomModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // åŠ è½½æ‰€æœ‰æˆ¿é—´
    function loadRooms() {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8080/room/getAllRoom', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    const rooms = JSON.parse(xhr.responseText);
                    renderRoomTable(rooms);
                } else {
                    showMessage('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥: ' + xhr.status, false);
                }
            }
        };

        // å‘é€ç©ºå¯¹è±¡ä½œä¸ºè¯·æ±‚ä½“
        xhr.send(JSON.stringify({}));
    }

    // æ¸²æŸ“æˆ¿é—´è¡¨æ ¼
    function renderRoomTable(rooms) {
        const tbody = document.querySelector('#roomTable tbody');
        tbody.innerHTML = '';

        rooms.forEach(room => {
            const row = document.createElement('tr');

            const nameCell = document.createElement('td');

            if (room.password != null && room.password != ''){
                nameCell.textContent = "ğŸ”’" + room.name;
            }else {
                nameCell.textContent = room.name;
            }

            row.appendChild(nameCell);

            const userNumCell = document.createElement('td');
            userNumCell.textContent = room.userNum;
            row.appendChild(userNumCell);

            const actionCell = document.createElement('td');
            actionCell.className = 'action-buttons';

            const editBtn = document.createElement('button');
            editBtn.textContent = 'ç¼–è¾‘';
            editBtn.className = 'secondary';
            editBtn.onclick = () => openModal(room);
            actionCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.className = 'danger';
            deleteBtn.onclick = () => confirmDeleteRoom(room.id, room.name, room.userNum);
            actionCell.appendChild(deleteBtn);

            row.appendChild(actionCell);
            tbody.appendChild(row);
        });
    }

    // æ·»åŠ åˆ é™¤ç¡®è®¤å‡½æ•°
    function confirmDeleteRoom(id, name, userNum) {
        if (userNum > 0){
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ³¨æ„å½“å‰ä»æœ‰"${userNum}"äººåœ¨çº¿ï¼Œä¸”æ­¤æ“ä½œä¸å¯é€†ã€‚`)) {
                deleteRoom(id);
            }
        }

        if (confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`)) {
            deleteRoom(id);
        }
    }

    // æäº¤æˆ¿é—´ï¼ˆæ·»åŠ æˆ–æ›´æ–°ï¼‰
    function submitRoom() {
        const id = document.getElementById('roomId').value;
        const name = document.getElementById('roomName').value;
        const password = document.getElementById('password').value;
        let hashedPassword = "";
        //å¦‚å¯†ç ä¸ä¸ºç©ºä¸”ä¸æ˜¯å·²åŠ å¯†è¿‡çš„sha256æ ¼å¼ï¼Œåˆ™è§†ä¸ºæœ‰æ•ˆæ–°å¯†ç å¹¶å¯¹å…¶è¿›è¡ŒåŠ å¯†,å¦åˆ™ä¸ºä¸æ”¹åŠ¨åŸå¯†ç 
        if (password != null && password != "" && !/^[a-f0-9]{64}$/i.test(password)){
            hashedPassword = sha256(password);
        }else{
            hashedPassword = password;
        }

        if (!name) {
            showMessage('æˆ¿é—´åç§°ä¸èƒ½ä¸ºç©º', false);
            return;
        }

        const room = {
            name: name,
            password: hashedPassword
        };
        let url = 'http://localhost:8080/room/insertRoom';
        let method = 'æ·»åŠ ';

        if (id) {
            room.id = parseInt(id);
            url = 'http://localhost:8080/room/updateRoom';
            method = 'æ›´æ–°';
        }

        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    if (result > 0) {
                        showMessage(`æˆ¿é—´${method}æˆåŠŸ`, true);
                        closeModal();
                        loadRooms();
                    } else {
                        showMessage(`æˆ¿é—´${method}å¤±è´¥`, false);
                    }
                } else {
                    showMessage(`æˆ¿é—´${method}å¤±è´¥: ` + xhr.status, false);
                }
            }
        };

        xhr.send(JSON.stringify(room));
    }

    // åˆ é™¤æˆ¿é—´
    function deleteRoom(id) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8080/room/removeRoom', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    if (result > 0) {
                        showMessage('æˆ¿é—´åˆ é™¤æˆåŠŸ', true);
                        loadRooms();
                    } else {
                        showMessage('æˆ¿é—´åˆ é™¤å¤±è´¥', false);
                    }
                } else {
                    showMessage('æˆ¿é—´åˆ é™¤å¤±è´¥: ' + xhr.status, false);
                }
            }
        };

        // å‘é€IDä½œä¸ºè¯·æ±‚å‚æ•°
        xhr.send(JSON.stringify({ id: id }));
    }

    function sha256(message) {
        const hash = CryptoJS.SHA256(message);
        return hash.toString(CryptoJS.enc.Hex);
    }

    function cleanPassword(){
        document.getElementById('password').value = '';
    }

    async function init() {
        try {
            const response = await fetch('http://localhost:8080/login/checkSession', {
                method: 'GET',
                credentials: 'include' // åŒ…å«cookie
            });

            const result = await response.json();

            if (result.isAuthenticated) {
                loadRooms();
            }else {
                // å¦‚æœæ²¡æœ‰æœ‰æ•ˆä¼šè¯ï¼Œè·³è½¬åˆ°ç™»å½•ç•Œé¢
                alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/index.html';
            }
        } catch (error) {
            console.error('æ£€æŸ¥ä¼šè¯é”™è¯¯:', error);
            window.location.href = '/index.html';
        }
    }
</script>
</body>
</html>